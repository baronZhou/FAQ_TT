## Trustonic_tee(TSP) FAQ

一些常见的问题，仅供参考.


#### Trustonic TEE、TSP(Trusted Secured Platform)介绍？

> [点击此处-Trustonic Trusted Execution Environment - youtube视频](https://www.youtube.com/watch?v=K7M63z0vCm0)

#### TAP(Trustonic Application Protection)介绍？

> [点击此处-Trustonic Application Protection (TAP) Overview - youtube视频](https://www.youtube.com/watch?v=Zh7jpH96wQ8&t=79s)

#### 如何开启trustonic_tee？

MTK的代码中，已经默认集成了trustonic TEE. 开启Trustonic TEE只需打开下列4个仓库下的宏开关即可

**(1)、preloader**

(vendor\mediatek\proprietary\bootable\bootloader\preloader\custom\${PROJECT}\${PROJECT}.mk)

```c
MTK_TEE_SUPPORT = yes

TRUSTONIC_TEE_SUPPORT = yes

MICROTRUST_TEE_SUPPORT = no

MTK_GOOGLE_TRUSTY_SUPPORT = no

export MTK_TEE_SUPPORT TRUSTONIC_TEE_SUPPORT MICROTRUST_TEE_SUPPORT MTK_GOOGLE_TRUSTY_SUPPORT
```

**(2)、kernel**

(${KERNEL_VER}\arch\arm\configs\${PROJECT}_debug_defconfig)<br>
(${KERNEL_VER}\arch\arm\configs\${PROJECT}_defconfig)<br>
(${KERNEL_VER}\arch\arm64\configs\${PROJECT}_debug_defconfig)<br>
(${KERNEL_VER}\arch\arm64\configs\${PROJECT}_defconfig)<br>

```c
CONFIG_TRUSTONIC_TEE_SUPPORT=y

CONFIG_MTK_TEE_GP_SUPPORT=y 
```

**(3)、projectConfig**

(device\mediatekprojects\${PROJECT}\ProjectConfig.mk)

```c
MTK_ATF_SUPPORT=yes

MTK_TEE_SUPPORT=yes

TRUSTONIC_TEE_SUPPORT=yes

MTK_TEE_GP_SUPPORT=yes 
```

**(4)、trustzone**

(vendor\mediatek\proprietary\trustzone\custom\build\project\${PROJECT}.mk)

```c
MTK_ATF_SUPPORT=yes

MTK_TEE_SUPPORT=yes

TRUSTONIC_TEE_SUPPORT=yes

MTK_TEE_DRAM_SIZE=0x1740000（根据你自己的TA来调整）

500A
CONFIG_TEE=y 否则无法编译到gud driver
```

#### 如何确认trustonic tee启动OK？

**(1)、通过log确认**

在Kernel log中搜索`Trustonic TEE`关键字，看是否有异常


**(2)、通过log确认**

查看进程是否起来
```c
ps -ef | grep mcDriverDaemon
```

**(3)、通过密码锁**

设置图案锁或密码锁，然后解锁测试


#### MTK平台上使用Trustonic TEE调试指纹的步骤？

- 开启trustonic_tee宏，编译能通过，能开机<br>
- trustonic release internal目录(SDK)给 oem，oem将此目录放入到`vendor/mediatek/proprietary/trustzone/trustonic/`路径下<br>
- oem检查spi驱动的完整性，如不完整，需向MTK申请spi patch<br>
- 在以上步骤完成后，oem编译出spi drv lib库，oem将这些库release给指纹厂商<br>
- 指纹厂商编译出drvlib和talib，release给OEM<br>
- oem将drvlib和talib合入到代码中<br>

#### 如何使用Trustonic TEE SDK编译TA？

[参考这篇文章进行SDK配置,以及TA Sample Code](https://gitee.com/baron_zz/test_ca_ta)

#### 如何开启实体RPMB?

MTK代码中，默认使用虚拟RPMB(即persist分区)，如需开启实体RPMB，需要进行一些配置.

如下有两种开启实体Rpmb的方法：<br>

- (1)将drRpmb driver打包到tee.img中
```c
$ python imageBuilder.py \
	--input ./t-base/Bin/MobiCore/$TARGET/$MODE/tee.img \
	--output SecureIntegration/t-base-kit/Out/$PLATFORM/$MODE/tee.img \
	--services drrpmb:startOnBoot:none:07050000…0021.tlbin
```

- (2)将drRpmb driver作为一般的sec driver放在vendor/app/mcRegister下
```c
cd SecureIntegration/t-base-kit
$ TARGET=HUAWEI_AARCH32_HIKEY \
./Locals/Build/build.sh --rpmb-bin 07050000…0021.tlbin \
	--rpmb-drv-flags startableAfterBoot
```


#### 如何客制化googlekey？

> [请参考csdn的这篇博客](https://blog.csdn.net/weixin_42135087/article/details/106761192)

#### googlekey安装失败了怎么办？

请确保`test_key.cfg`文件中的`EKKB_PUB`和`PKB`的数组已替换成你们自己的了
```c
(vendor/mediatek/proprietary/trustzone/trustonic/source/bsp/common/500/t-sdk/TlSdk/Out/Bin/KeyReplace/test_key.cfg)

EKKB_PUB {
    0x54, 0xCB, 0xCD, 0xB3, 0xFF, 0xCD, 0xCC, 0xDD, 0xA3, 0xFF, 0x5D, 0x30, 0x95, 0x03, 0x2D, 0x2A,
	0x2A, 0x12, 0xE6, 0x90, 0x0B, 0x3F, 0xF7, 0x85, 0xE5, 0xB3, 0xDD, 0x8E, 0x4B, 0x27, 0x9D, 0x58,
	0xC8, 0x24, 0x7A, 0xB0, 0x83, 0x8B, 0xB1, 0xD4, 0xA4, 0x92, 0x17, 0x0E, 0xF2, 0xCF, 0x19, 0x9A,
	0xAB, 0xCE, 0xFB, 0x68, 0xCB, 0x86, 0x94, 0x6E, 0x16, 0x8E, 0x3D, 0xCC, 0xF8, 0x0C, 0xA6, 0x30,
	0x1C, 0x47, 0xA6, 0xB6, 0x50, 0x2F, 0x68, 0x94, 0x23, 0x0C, 0x62, 0xAF, 0xE1, 0x44, 0xA4, 0x27,
	0xD8, 0x79, 0x05, 0x68, 0x51, 0x89, 0x04, 0x49, 0x61, 0x93, 0x7A, 0xEF, 0xB5, 0xB9, 0x17, 0x72,
	0x28, 0x87, 0xBA, 0x94, 0x4A, 0xB8, 0xF1, 0x46, 0xCF, 0xE7, 0x53, 0x0A, 0x02, 0x5A, 0xEE, 0x59,
	0x47, 0xBE, 0xC2, 0x41, 0x98, 0xD9, 0x5B, 0x17, 0xAF, 0x10, 0x0B, 0xE0, 0x92, 0xBA, 0x65, 0x30,
 	0x63, 0x76, 0x94, 0x2A, 0x26, 0x7D, 0x3F, 0x94, 0x2E, 0x9F, 0x06, 0xB8, 0xD3, 0xB0, 0x76, 0xE9,
 	0xBD, 0xBA, 0x07, 0x6E, 0xE1, 0x3D, 0x1F, 0xC6, 0xDB, 0x7F, 0x34, 0xC1, 0xB4, 0xED, 0x8B, 0x00,
 	0x36, 0xAE, 0x1E, 0xBB, 0x65, 0x81, 0x38, 0x94, 0x77, 0xE2, 0x4E, 0x5C, 0xC1, 0x9F, 0x93, 0x2D,
 	0x29, 0xA3, 0x30, 0x29, 0xF7, 0xEC, 0xFC, 0xCC, 0x87, 0x3F, 0xFA, 0x09, 0xAD, 0x1E, 0xE5, 0xAF,
 	0x4E, 0xCF, 0x0E, 0x44, 0x8C, 0xE3, 0xBF, 0x8D, 0x5B, 0xEB, 0xD6, 0xA0, 0xEA, 0xC6, 0xBF, 0xB1,
 	0x56, 0xD5, 0xC9, 0xE6, 0xB8, 0xE1, 0xB9, 0x94, 0x85, 0xAD, 0x38, 0x38, 0xDD, 0xE2, 0x57, 0xCC,
 	0xFE, 0xED, 0xF0, 0x2A, 0x10, 0xB6, 0x8E, 0x3C, 0xA2, 0x4D, 0x97, 0x60, 0x3E, 0xEC, 0x92, 0xE2,
 	0xC1, 0x72, 0xB6, 0x38, 0xE2, 0xC0, 0xA8, 0xCA, 0xD6, 0xEB, 0x0C, 0x35, 0xE9, 0x3E, 0x8D, 0x91
 }
 
PKB {
     0x00,
 	0x05, 0x14, 0x24, 0x14, 0x2F, 0xE1, 0xFC, 0x61, 0xB1, 0x0B, 0x97, 0xAF, 0x5C, 0x66, 0xB0, 0xF6,
 	0x15, 0x26, 0xF6, 0x1C, 0x96, 0xC8, 0xBA, 0x96, 0x77, 0xD5, 0x4E, 0xFB, 0xA4, 0x91, 0xFD, 0xFB,
 	0x16, 0x33, 0xED, 0x6E, 0xCC, 0x41, 0x0F, 0xCF, 0xC2, 0x94, 0xC2, 0x64, 0x1C, 0xFA, 0x12, 0x66,
 	0x04, 0xE3, 0x4C, 0xF0, 0xB4, 0x5F, 0x15, 0x4B, 0xDB, 0xF4, 0x29, 0x1F, 0x98, 0xD3, 0xF5, 0x4E,
 	0xA8, 0xD2, 0xA1, 0x0E, 0x8B, 0x59, 0xBF, 0x17, 0xDE, 0xB7, 0xA7, 0x50, 0x02, 0x2F, 0x14, 0x9C,
 	0x7A, 0xE5, 0x24, 0x6D, 0x0E, 0x9F, 0xDE, 0x45, 0x4D, 0x6A, 0x75, 0x06, 0xB3, 0xDA, 0x88, 0x86,
 	0x8D, 0xA6, 0x11, 0x43, 0xA8, 0x17, 0xA9, 0x6F, 0x70, 0x27, 0x01, 0xDA, 0xFA, 0xAF, 0xF6, 0xA8,
 	0x47, 0xEC, 0xEF, 0x29, 0x66, 0x4E, 0xA8, 0x7C, 0x99, 0xFA, 0x40, 0xB8, 0xD4, 0x8A, 0x2C, 0xB1
 }

```

#### 如何进行TA签名



